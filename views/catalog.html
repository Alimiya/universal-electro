<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Electro</title>
    <%- include('./components/head.ejs.html') %>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><img src="/public/images/logo.png" width="150" alt="" /></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="#">Товары</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/requests">Запросы</a>
                        </li>
                    </ul>
                    <a class="btn btn-outline-primary" href="/login">Выйти</a>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container d-flex align-items-center gap-5" style="width: 78%;">
            <h1>Наш каталог</h1>
            <div class="bucket_btn bg-light rounded pt-1 px-2 d-flex align-items-center btn" onclick="showBucket()">
                <span class="material-symbols-outlined" style="font-size: 30px; font-variant: bold;">
                    shopping_cart_checkout
                </span>
                <div id="products_count" class="h1"></div>
            </div>
        </div>
        <div class="container d-flex align-items-center gap-3" style="width: 78%;">

            <div class="search position-relative w-75">
                <input class="form-control me-2 w-100 search-input border-secondary ps-5"
                    onkeyup="searchProduct(this.value)" type="search" placeholder="Введите" aria-label="Search" />
                <span class="material-symbols-outlined position-absolute top-50 translate-middle ps-5">
                    search
                </span>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" type="button" onclick="showAddProductModal()">
                    + Добавить
                </button>
            </div>

        </div>

        <div class="container d-flex flex-wrap gap-3 " id="catalog">

        </div>
    </main>
    <footer></footer>

    <div class="modal modal-lg fade" id="show_bucket-modal">
        <div class="modal-dialog text-left">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Оформить заказ</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex">
                    <div class="order_form w-50 px-5">
                        <div class="mb-3 mt-3">
                            <label for="name" class="form-label">Ваше имя:</label>
                            <input type="text" class="form-control" id="name" placeholder="Введите имя" name="name">
                        </div>
                        <div class="mb-3">
                            <label for="phone_number" class="form-label">Ваш номер:</label>
                            <input type="tel" class="form-control" id="phone_number" placeholder="Введите номер"
                                name="phone_number">
                        </div>
                        <button type="submit" id="place_older_btn" class="btn btn-primary"
                            onclick="placeOrder()">Отправить</button>
                    </div>
                    <div class="bucket flex-fill">
                        <h3>Корзина</h3>
                        <div id="bucket_content"></div>
                        <h4>Общая сумма: <span id="total_amount">492</span> ₸</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var products;
        $(() => {
            loading(1);
            showCatalog();
        });

        function showCatalog() {
            let i = 1;
            $("#catalog").html('');
            let productsHTML = "";
            $.ajax({
                url: "/api/catalog/products",
                method: "get",
                success: function (data) {
                    products = data;
                    data.forEach((p) => {
                        productsHTML += `
                        <div class="product" id="product-${i}">
                            <div class="h-50">
                                <img src="${p.product_img}" alt="">
                            </div>
                            <i>Артикул: ${p.articul}</i>
                            <h3>${p.title}</h3>
                            ${p.status == '1' ? '<p class="text-success">В наличии</p>' : '<p class="text-danger">Нет в наличии</p>'}
                            <h2>${p.price} ₸</h2>
                            <button class="btn btn-dark px-4 py-2" onclick="addToBucket('product-${i}', '${p.product_id}')">В корзину</button>
                        </div>`
                        i++;
                    });
                    $("#catalog").append(productsHTML);
                    showCountProducts();
                    loading(0);
                },
            });
        }

        function addToBucket(product_index) {
            let product = products[product_index.split('-')[1] - 1];

            if (localStorage.getItem('products_list')) {
                let productsList = localStorage.getItem('products_list');
                let data = getProductById(JSON.parse(productsList), product.product_id);

                if (data) {
                    var updatedProductsList = JSON.parse(productsList).map(product => {
                        if (product.product_id === data.product_id) {
                            return { ...product, count: product.count + 1 };
                        }
                        return product;
                    });
                    localStorage.setItem('products_list', JSON.stringify(updatedProductsList));
                } else {
                    var updatedProductsList = JSON.parse(productsList);
                    product['count'] = 1;
                    updatedProductsList.push(product);
                    localStorage.setItem('products_list', JSON.stringify(updatedProductsList));
                }
            } else {
                product['count'] = 1;
                let productsList = [product];
                localStorage.setItem('products_list', JSON.stringify(productsList));
            }

            showCountProducts();
        }

        function showBucket() {
            showBucketProducts();
            $('#show_bucket-modal').modal('show');
        }

        function showBucketProducts() {
            let productsList = JSON.parse(localStorage.getItem('products_list'));
            let productsCount = showCountProducts();
            var bucketContentHTML = '';
            if (productsCount) {
                productsList.forEach((product) => {
                    if (!product.count) return;
                    bucketContentHTML += `
                        <div class="bucket_product d-flex align-items-start gap-3">
                            <img src="${product.product_img}"
                                alt="" width="100">
                            <div>
                                <h4>${product.title}</h4>
                                <div class="d-flex justify-content-between">
                                    <div class="d-flex w-25">
                                        <button class="btn btn-light" onclick="decreaseCount('${product.product_id}')">-</button>
                                        <input type="tel" class="form-control col-3" value="${product.count}" onchange="changeCount('${product.product_id}', this.value)">
                                        <button class="btn btn-light" onclick="increaseCount('${product.product_id}')">+</button>
                                    </div>
                                </div>
                                <h4>${product.price * product.count} ₸</h4>
                            </div>
                        </div>
                        `;
                    $('#bucket_content').html(bucketContentHTML);

                    setTimeout(() => {
                        $('#bucket_content .temp').remove();
                    }, 3000)
                });
            } else {
                bucketContentHTML += `
                <div class="alert alert-light">
                    У вас нет выбранных товаров.
                </div>
                `;
                $('#bucket_content').html(bucketContentHTML);
            }
            showTotalAmount();
        }

        function getProductById(products_list, productId) {
            return products_list.find(product => product.product_id == productId);
        }

        function showCountProducts() {
            var count = 0;
            let productsList = JSON.parse(localStorage.getItem('products_list'));
            if (productsList) {
                productsList.forEach((product) => {
                    count += product.count;
                });
                $('#products_count').html(count);
                return count;
            } else {
                $('#products_count').html(0);
                return 0;
            }
        }

        function increaseCount(product_id) {
            let productsList = localStorage.getItem('products_list');
            var updatedProductsList = JSON.parse(productsList).map(product => {

                if (product.product_id == product_id) {
                    return { ...product, count: product.count + 1 };
                }
                return product;
            });

            localStorage.setItem('products_list', JSON.stringify(updatedProductsList));
            showBucketProducts();
            showCountProducts();
        }

        function decreaseCount(product_id) {
            let productsList = localStorage.getItem('products_list');
            var updatedProductsList = JSON.parse(productsList).map(product => {
                if (product.count > 0) {
                    console.log(product.count)
                    if (product.product_id == product_id) {
                        return { ...product, count: product.count - 1 };
                    }
                }
                return product;
            });

            localStorage.setItem('products_list', JSON.stringify(updatedProductsList));
            showBucketProducts();
            showCountProducts();
        }

        function changeCount(product_id, count) {
            console.log(Number(count))
            let productsList = localStorage.getItem('products_list');
            var updatedProductsList = JSON.parse(productsList).map(product => {
                if (product.count >= 0) {
                    if (product.product_id == product_id) {
                        return { ...product, count: Math.abs(Number(count)) };
                    }
                }
                return product;
            });

            localStorage.setItem('products_list', JSON.stringify(updatedProductsList));
            showBucketProducts();
            showCountProducts();
        }

        function placeOrder() {
            loading(2, el = '#place_older_btn');
            let name = $('#name').val().trim();
            let phone_number = $('#phone_number').val();
            let products = localStorage.getItem('products_list');
            if (!name || !phone_number) {
                $.ambiance({
                    message: "Заполните все поля",
                    type: "error",
                    fade: true,
                    width: 400,
                });
                return loading(20, el = '#place_older_btn');
            }

            if (!products) {
                $.ambiance({
                    message: "Ваша корзина пуста",
                    type: "error",
                    fade: true,
                    width: 400,
                });
                return loading(20, el = '#place_older_btn');
            }

            $.ajax({
                url: '/api/catalog/request/create',
                method: 'POST',
                data: {
                    name: name,
                    phone_number: phone_number,
                    products: products
                },
                success: function (r) {
                    console.log(r);
                    $.ambiance({ type: 'success', message: 'Success' });
                    loading(20, el = '#place_older_btn');
                    localStorage.removeItem('products_list');
                    $('#show_bucket-modal').modal('hide');
                    $('#products_count').html(0);
                    $('#bucket_content').html('');
                }
            });
        }

        function showTotalAmount(){
            let total_amount = 0;
            let productsList = JSON.parse(localStorage.getItem('products_list'));
            let productsCount = showCountProducts();
            console.log(productsCount)
            if (productsCount) {
                productsList.forEach((product) => {
                    console.log(product)
                    if (!product.count) return;
                    total_amount+= Number(product.price) * product.count
                });
                $('#total_amount').parent().css('display', 'block');
                $('#total_amount').html(total_amount);
            } else {
                $('#total_amount').parent().css('display', 'none');
            }
        }

    </script>





</body>

</html>